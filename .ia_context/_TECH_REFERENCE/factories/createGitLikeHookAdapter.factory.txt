/* eslint-disable @typescript-eslint/no-explicit-any */
import { useCallback } from 'react';
import { GitLikeState, GitLikeStore } from '../create-git-like-zustand-store';

/**
 * Creates a “stable” hook on top of a git-like store.
 * This hook is what the UI consumes (stable port).
 * If tomorrow you replace Zustand with something else, you can re-implement this factory
 * and the UI won’t notice.
 */
export function createGitLikeHookAdapterFactory<T>(useStore: GitLikeStore<T>) {
  return function useGitLike(): Pick<
    GitLikeState<T>,
    | 'stashData'
    | 'commitData'
    | 'stash'
    | 'stashField'
    | 'commit'
    | 'discard'
    | 'resetStash'
    | 'resetRepo'
    | 'getStash'
    | 'getCommit'
  > {
    // Data
    const stashData = useStore((s) => s.stashData);
    const commitData = useStore((s) => s.commitData);

    // Actions
    const _stash = useStore((s) => s.stash);
    const _stashField = useStore((s) => s.stashField);
    const _commit = useStore((s) => s.commit);
    const discard = useStore((s) => s.discard);
    const resetStash = useStore((s) => s.resetStash);
    const resetRepo = useStore((s) => s.resetRepo);

    // Fresh getters
    const getStash = () => useStore.getState().stashData;
    const getCommit = () => useStore.getState().commitData;

    // Memoized handlers (preserve method overloads)
    const stash: GitLikeState<T>['stash'] = useCallback(
      ((arg: any) => _stash(arg)) as unknown as GitLikeState<T>['stash'],
      [_stash],
    );

    const stashField: GitLikeState<T>['stashField'] = useCallback(
      // _stashField may be “never” depending on T; the cast respects the conditional contract
      ((key: any, value: any) =>
        (_stashField as any)?.(
          key,
          value,
        )) as unknown as GitLikeState<T>['stashField'],
      [_stashField],
    );

    const commit: GitLikeState<T>['commit'] = useCallback(
      ((arg?: any) => _commit(arg)) as unknown as GitLikeState<T>['commit'],
      [_commit],
    );

    return {
      stashData,
      commitData,
      stash,
      stashField,
      commit,
      discard,
      resetStash,
      resetRepo,
      getStash,
      getCommit,
    };
  };
}
